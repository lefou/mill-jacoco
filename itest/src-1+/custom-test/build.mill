package build

import de.tobiasroeser.mill.jacoco._

import mill._
import mill.api._
import mill.scalalib._

object main extends JavaModule {
  // no tests in here
  object test extends JavaTests with JacocoTestModule with TestModule.Junit4
  // but here
  object customTest extends JavaTests with JacocoTestModule with TestModule.Junit4 {
    override def junit4Version = "4.12"
  }
}

def verify(millVersion: String): Task.Command[Unit] = Task.Command {
  val jacocoPath = if(millVersion.startsWith("1.0")) {
    BuildCtx.workspaceRoot / "out/de/tobiasroeser/mill/jacoco/Jacoco/jacocoReportFull.dest"
  } else {
    BuildCtx.workspaceRoot / "out/de.tobiasroeser.mill.jacoco.Jacoco/jacocoReportFull.dest"
  }
  val xml = jacocoPath / "jacoco.xml"
  assert(os.exists(jacocoPath), s"Path does not exist: ${jacocoPath}")
  assert(os.exists(xml), s"XML report does not exist: ${xml}")
  val contents = os.read(xml)
  assert(contents.contains("""<class name="test/Main" sourcefilename="Main.java">"""))
  assert(contents.contains("""<sourcefile name="Main.java">"""))
  // this file should be excluded from report, as it belongs to the test sources
  assert(!contents.contains("""<class name="test/MainTest" sourcefilename="MainTest.java">"""))
  ()
}
